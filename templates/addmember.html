{% extends "base.html" %}
{% block title %}{{title}}{% endblock %}
{% block body %}
<div class="col-md-6 offset-md-3">
    <span class="anchor"></span>
    <hr class="my-5">
    <div class="container-fluid d-flex justify-content-center align-content-center align-items-center">
        <div class="container">
            <div class="row d-flex justify-content-center">
                <div class="col-md-6 col-lg-10 col-sm-12 col  p-4"
                    style=" box-shadow: 13px 13px 20px #cbced1, -13px -13px 20px #fff !important;border-radius: 15px; background-color: #ecf0f3; ">
                    <h3 class="text-center">{{option}}</h3>
                    <hr>
                    <form action="{{url}}" id="image_form">
                        {%csrf_token%}
                        <div class="container">
                            <div class="row">
                                {{ form.as_p }}
                            </div>
                            <div id="image-box" class="mb-3"></div>
                        </div>
                        <div class="container">
                            <div class="row align-items-start">
                                <div class="col">
                                    <input type="button" value="submit" class="btn btn-success" id="submit_btn">
                                </div>
                                <div class="col">
                                    <a href="/details/"><button type="button" class="btn btn-dark btn-rounded "
                                            id="back" data-mdb-ripple-color="#ffffff"> <i class="fas fa-arrow-left"></i>
                                            Back</button></a>
                                </div>
                            </div>
                        </div>
                        <div id="spinner" style="display:none;">
                            Uploading Please Wait
                            <div class="spinner-border text-primary" role="status"><span class="visually-hidden"></span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    const input = document.getElementById("id_image")
    const imagebox = document.getElementById("image-box")
    const confirmbtn = document.getElementById('submit_btn')
    const csrf = document.getElementsByName('csrfmiddlewaretoken')
    const imageform = document.getElementById('image_form')
    const MAX_WIDTH = 320;
    const MAX_HEIGHT = 180;
    const MIME_TYPE = "image/jpeg";
    const QUALITY = 0.9;

    input.onchange = function (ev) {
        const image_data = input.files[0]
        const url = URL.createObjectURL(image_data);
        imagebox.innerHTML = `<h6>Please Crop your image below<h6><img src="${url}" id="image" width="300px">`
        var $image = $('#image');
        $image.cropper({
            aspectRatio: 1 / 1,
            crop(event) {
                console.log(event.detail.x);
                console.log(event.detail.y);
                console.log(event.detail.width);
                console.log(event.detail.height);
            },
        });
        var cropper = $image.data('cropper');
        confirmbtn.addEventListener('click', () => {
            cropper.getCroppedCanvas().toBlob((blob) => {
                console.log(blob)
                var objectURL = URL.createObjectURL(blob);
                const img = new Image();
                img.src = objectURL;
                img.onerror = function () {
                    URL.revokeObjectURL(this.src);
                    // Handle the failure properly
                    console.log("Cannot load image");
                };
                img.onload = function () {
                    URL.revokeObjectURL(this.src);
                    const [newWidth, newHeight] = calculateSize(img, MAX_WIDTH, MAX_HEIGHT);
                    const canvas = document.createElement("canvas");
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    canvas.toBlob(
                        (blob) => {
                            // Handle the compressed image. es. upload or save in local state
                            const fd = new FormData()
                            var name = $("#id_name").val();
                            var password = $("#id_password").val();
                            fd.append('csrfmiddlewaretoken', csrf[0].value)
                            fd.append('name', name)
                            fd.append('password', password)
                            fd.append('image', blob, 'my_imgage.png')
                            for (var key of fd.entries()) {
                                console.log(key[0] + ', ' + key[1]);
                            }
                            $.ajax({
                                type: "POST",
                                url: imageform.action,
                                enctype: 'multipart/form-data',
                                data: fd,
                                success: function (response) {
                                    location.href = "/details/"
                                },
                                eror: function (response) {
                                    console; log(response)
                                },
                                cache: false,
                                contentType: false,
                                processData: false

                            })
                        },
                        MIME_TYPE,
                        QUALITY
                    );
                };
            })
            document.getElementById("submit_btn").style.visibility = "hidden"
            document.getElementById("back").style.visibility = "hidden"
            document.getElementById("spinner").style.display = "block"
            alertify.alert('Do not Close', 'Please Wait your details are updating.<div class="spinner-border text-primary" role="status"><span class="visually-hidden"></span></div>').set('maximize', true);
        })
    };

    function calculateSize(img, maxWidth, maxHeight) {
        let width = img.width;
        let height = img.height;

        // calculate the width and height, constraining the proportions
        if (width > height) {
            if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
            }
        } else {
            if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
            }
        }
        return [width, height];
    }

</script>
<style>
    .errorlist {
        border: 2px red solid;
        background-color: #ecf0f3;
    }
</style>
{%endblock body%}